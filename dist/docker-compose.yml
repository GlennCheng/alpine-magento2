version: "2"

volumes:
    database:
#    app-sync:
#        external: true
#networks:
#    default:
#        driver: bridge
#        ipam:
#            config:
#                - subnet: "192.168.7.0/28"

networks:
    web:
         external: true
    network-back:
         external: false
#    internal:
    connection:
        ipam:
            config:
                - subnet: "192.168.7.0/28"


services:
    php-fpm:
        image: sharaths/magento-alpine:php-fpm-7.1
        restart: unless-stopped
        volumes:
            - ./public_html:/var/www/html:rw
        networks:
            - network-back
        networks:
            connection:
                aliases:
                    - php-fpm.local.com
        environment:
            - VERBOSE=true
        links:
            - mysql
            - redis
    php-cli:
        image: sharaths/magento-alpine:php-cli-7.1
        volumes:
            - ./public_html:/var/www/html:rw
        networks:
            - network-back
        networks:
            connection:
                aliases:
                    - php-cli.local.com
        links:
            - mysql
            - redis
    php-cron:
        image: sharaths/magento-alpine:php-cron-7.1
        restart: unless-stopped
        volumes:
            - ./public_html:/var/www/html:rw
        networks:
            - network-back
        networks:
            connection:
                aliases:
                    - php-cron.local.com 
        environment:
            - VERBOSE=false
        links:
            - mysql
            - redis
    nginx:
        image: sharaths/magento-alpine:nginx
        restart: unless-stopped
        volumes:
            - ./public_html:/var/www/html:rw
        labels:
            - traefik.enable=true
            - traefik.frontend.rule=Host:magento.local.com
            - traefik.port=80
            - traefik.docker.network=web
        networks:
            - network-back
            - web 
        networks:
            connection:
                aliases:
                    - magento.local.com
        environment:
            - VERBOSE=true
            - MAGENTO_VERSION=2
        links:
            - php-fpm
#        ports:
#            - "443:443"

#    nv:
#        image: sharaths/magento-alpine:nv
#        restart: unless-stopped
#        volumes:
#            - ./public_html:/var/www/html:rw
#        labels:
#            - traefik.enable=true
#            - traefik.frontend.rule=Host:magento.local.com
#            - traefik.port=8080
#            - traefik.docker.network=web
#        networks:
#            - network-back
#            - web
#        networks:
#            connection:
#                aliases:
#                    - magento.local.com
#                    - varnish.local.com
#                    - localhost
#        environment:
#            - VERBOSE=true
#            - MAGENTO_VERSION=2
#        links:
#            - php-fpm

    mysql:
        image: sharaths/magento-alpine:mysql
        restart: unless-stopped
        volumes:
            - database:/var/lib/mysql
        networks:
            - network-back
        networks:
            connection:
                aliases:
                    - localhost
                    - mysql.local.com
        environment:
            - VERBOSE=false
            - MYSQL_ROOT_PASSWORD=magento
            - MYSQL_USER_NAME=magento
            - MYSQL_USER_PASSWORD=magento
            - MYSQL_DATABASE=magento
#    varnish:
#        image: sharaths/magento-alpine:varnish
#        restart: unless-stopped
#        environment:
#            - VERBOSE=false
#        labels:
#            - traefik.enable=true
#            - traefik.frontend.rule=Host:magento.local.com
#            - traefik.port=80
#            - traefik.docker.network=web
#        networks:
#            - web
#            - internal
#        networks:
#            connection:
#                 aliases:
#                     - varnish.local.com
#        links:
#            - nginx
#        ports:
#            - "80:80"
    redis:
        image: sharaths/magento-alpine:redis
        restart: unless-stopped
        networks:
            - network-back
        networks:
            connection:
                aliases:
                    - redis.local.com
        environment:
            - VERBOSE=false

